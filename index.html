<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Marriage Connection Assessment</title>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@500&family=Open+Sans:wght@600;700&display=swap" rel="stylesheet">

  <style>
    body { font-family: Arial, sans-serif; background: #FFF9F2; color: #1A3C5E; max-width: 900px; margin: auto; padding: 20px; box-sizing: border-box; }
    #resultPage { line-height: 1.3; color: #1A3C5E; }
    .intro-text { margin-bottom: 10px; line-height: 1.45; text-align: left; }
    h1, h2, h3, h4 { text-align: center; line-height: 1.25; }

    .card { background: #FFFFFF; border: 2px solid #4D9DE0; border-radius: 12px; padding: 25px; box-shadow: 0 8px 25px rgba(0,0,0,0.08); margin: 20px auto; max-width: 750px; text-align: center; }
    .btn, .answer-btn { background: #4D9DE0; color: white; font-weight: bold; border: none; border-radius: 8px; padding: 15px 25px; cursor: pointer; margin: 12px auto; display: block; width: 100%; max-width: 500px; text-align: center; touch-action: manipulation; }
    .btn:hover, .answer-btn:hover { background: #3A7FBF; }
    .answer-btn.selected { background: #3A7FBF; transform: scale(0.98); transition: all 0.2s ease; }
    #backBtn { padding: 8px 15px; max-width: 120px; font-size: 0.9rem; }
    .hidden { display: none; }

    .progress-bar-container { width: 100%; max-width: 500px; height: 10px; background: #E0E0E0; border-radius: 5px; margin: 10px auto; }
    .progress-bar { height: 100%; background: #FF4D4D; border-radius: 5px; transition: width 0.3s ease; }

    .logo { display: block; margin: 0 auto 15px auto; max-width: 200px; }
    .question-box { background: #FFFFFF; border: 1px solid #4D9DE0; border-radius: 8px; padding: 20px; margin: 15px auto; max-width: 700px; text-align: left; }

    .result-block { margin-bottom: 16px; page-break-inside: avoid; padding: 20px; border-left: 8px solid; border-radius: 8px; background: #FFFFFF; opacity: 0; transform: translateY(10px); animation: fadeIn 0.5s ease forwards; }
    @keyframes fadeIn { to { opacity: 1; transform: translateY(0); } }
    /* Disable animations when exporting/printing */
    .no-anim .result-block { opacity: 1 !important; transform: none !important; animation: none !important; }

    .results-list { list-style-position: outside; margin-left: 20px; text-align: left; }
    .results-list li { margin-bottom: 8px; }
    .verse { font-style: italic; color: #334E7D; text-align: center; margin: 6px auto 10px; max-width: 700px; }
    .section-title { color: #1A3C5E; font-family: 'Open Sans', sans-serif; font-size: 16pt; font-weight: 700; text-align: center; margin-bottom: 10px; }
    .subsection-title { color: #1A3C5E; font-family: 'Roboto', sans-serif; font-size: 14pt; font-weight: 600; text-align: center; margin: 15px 0 6px; }
    .section-divider { height: 1pt; background-color: #FF4D4D; width: 100%; max-width: 750px; margin: 25pt auto; }
    .subsection-divider { height: 1pt; background-color: rgba(77, 157, 224, 0.5); width: 100%; max-width: 750px; margin: 15pt auto; }

    .couple-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; align-items: start; position: relative; padding: 10px 0; }
    .couple-grid::before { content: ""; position: absolute; left: 50%; top: 0; width: 2px; height: 100%; background: #4D9DE0; transform: translateX(-1px); }
    .partner-card { border: none; }
    .partner-inner { border-radius: 12px; padding: 16px; }
    .partner-header { font-weight: 700; text-align: center; margin-bottom: 6px; font-size: 1rem; }
    .pill { display:inline-block; padding:6px 10px; border-radius:999px; margin:4px 4px 0 0; font-size:0.9rem; border:1px solid #E0E0E0; }
    .overlap-box { background:#FFFFFF; border-left:8px solid #FF4D4D; border-radius:8px; padding:16px; }

    .row { display:flex; gap:10px; justify-content:center; flex-wrap:wrap; margin: 10px 0 0; }
    .input { border:1px solid #4D9DE0; border-radius:8px; padding:10px 12px; min-width:220px; }
    .muted { color:#A3A3A3; font-size:0.9rem; margin-top:10px; }

    .handoff { border: 2px dashed #4D9DE0; border-radius: 12px; padding: 20px; background: #FFFFFF; text-align: center; }
    .handoff .intro-text { text-align: center; }

    .discussion-prompts { margin-top: 12pt; margin-bottom: 12pt; }

    table { width: 100%; border-collapse: collapse; margin: 20px 0; }
    th, td { border: 1px solid #E0E0E0; padding: 10px; text-align: left; vertical-align: top; }
    th { background: #4D9DE0; color: white; }

    /*  Solo layout overrides using same couple-grid styling, stacked vertically */
    .solo-layout .couple-grid { display: block !important; }
    .solo-layout .couple-grid::before { display: none !important; }
    .solo-layout .partner-card { margin-bottom: 20px; max-width: 100%; }

    @media print {
      .btn { display:none !important; }
      .card { border: none; box-shadow: none; }
      body { background: white; }
      .result-block { opacity: 1 !important; transform: none !important; animation: none !important; }
      .couple-grid { grid-template-columns: 1fr 1fr !important; }
      .couple-grid::before { display:none !important; }
    }
    @media (max-width: 600px) {
      .couple-grid { grid-template-columns: 1fr; }
      .couple-grid::before { display:none; }
      .partner-header { font-size: 1.05rem; }
    }
  </style>
</head>
<body>
  <!-- Intro Page -->
  <div id="introPage" class="card">
    <img src="https://static.wixstatic.com/media/4d6372_c110ccf05896482192f466d6c0e3c1ae~mv2.png" class="logo" alt="Logo" onerror="this.src='https://via.placeholder.com/200x80?text=Logo'"/>
    <h1>Discover Your Marriage Connection Profile</h1>
    <div class="intro-text">
      <h3 style="text-align:center;margin-top:0;">Unlock Your Marriage Connection: A Guide to Deeper Intimacy</h3>
      <p>Welcome to the Marriage Connection Assessment, a guided experience designed to help you and your spouse build a happy, covenant, and joy-filled marriage as God designed. ...</p>
      <p>Whether you take it alone or as a couple, you'll receive tailored insights. Complete solo to get a vertical personalized report—or together for a side‑by‑side comparison.</p>
    </div>
    <div class="row">
      <label><input type="checkbox" id="coupleModeToggle"/> Take as a couple</label>
    </div>
    <div class="row" id="nameRow">
      <input id="partnerAName" class="input" placeholder="Your name (or Partner A)"/>
      <input id="partnerBName" class="input hidden" placeholder="Partner B name"/>
    </div>
    <div style="display:flex; justify-content:center;">
      <button id="startQuizBtn" class="btn" style="max-width:250px;">Start Assessment</button>
    </div>
    <p class="muted">HappyMarriageHappyLife.com</p>
  </div>

  <!-- Quiz Page -->
  <div id="quizPage" class="card hidden">
    <h2 id="quizTitle">Intimacy Profile Assessment</h2>
    <div class="progress-bar-container"><div class="progress-bar" id="progressBar"></div></div>
    <div class="progress" id="progress"></div>
    <div class="question-box" id="questionContainer" role="radiogroup"></div>
    <button class="btn" onclick="goBack()" id="backBtn" style="display: none;">Previous Question</button>
    <p class="muted">HappyMarriageHappyLife.com</p>
  </div>

  <!-- Result Page -->
  <div id="resultPage" class="card hidden">
    <img src="https://static.wixstatic.com/media/4d6372_c110ccf05896482192f466d6c0e3c1ae~mv2.png" class="logo" alt="Logo" onerror="this.src='https://via.placeholder.com/200x80?text=Logo'"/>
    <h2 id="resultsHeader">Your Personalized Connection Profile</h2>
    <div class="intro-text" id="resultsIntro">
      <h3 style="text-align:center;margin-top:0;">Your Marriage Connection Profile: The Journey Begins</h3>
      <p>This profile is built on the Covenant Intimacy Fulfillment Model™ (CIFM) and helps guide your connection thoughtfully. ...</p>
    </div>
    <div id="results"></div>
    <div id="coupleFlowBtns" class="hidden" style="margin-top:20px;">
      <button id="startPartnerBBtn" class="btn">Start Partner B</button>
    </div>
    <p class="muted">HappyMarriageHappyLife.com</p>
  </div>

  <script>
    /* ================== Data & Text ================== */
    const intimacyDescriptions = { Spiritual:{desc:"You value a shared faith or sense of purpose..."}, Emotional:{desc:"You seek emotional safety and vulnerability..."}, Commitment:{desc:"You prioritize trust and loyalty..."}, Intellectual:{desc:"You connect through stimulating ideas..."}, Affable:{desc:"You cherish kindness, peace, and joy..."}, Recreational:{desc:"You bond through shared activities..."}, Partnership:{desc:"You value teamwork and collaboration..."}, Stability:{desc:"You find unity through transparent, honest management..."}, Creative:{desc:"You connect through imagination and collaboration..."}, Conflict:{desc:"You grow closer through respectful resolution..."}, Physical:{desc:"You feel loved through non-sexual touch..."}, Sexual:{desc:"You express passion and intimacy through sexual connection..."} };
    const typeColors = { Spiritual:"#6A4C93", Emotional:"#FF7A70", Commitment:"#FFB347", Intellectual:"#4C6B9B", Affable:"#FFB6C1", Recreational:"#4DD2FF", Partnership:"#3CB371", Stability:"#FFD700", Creative:"#FF66CC", Conflict:"#FFA552", Physical:"#FF8C69", Sexual:"#E63946", ExtrovertedExpress:"#FFB347", ExtrovertedReceive:"#FFD580", ReflectiveExpress:"#6A4C93", ReflectiveReceive:"#A68CC2", SupportiveExpress:"#88C0D0", SupportiveReceive:"#B2DFDB", AffableExpress:"#4CAF50", AffableReceive:"#A3D977", StrongWilledExpress:"#E63946", StrongWilledReceive:"#FF7A70", SteadyConnector:"#4CAF50", ReassuranceSeeker:"#FFADAD", IndependentConnector:"#88C0D0", GuardedConnector:"#A5A5A5" };
    const typeColorsWithOpacity = { Spiritual:"rgba(106, 76, 147, 0.08)", Emotional:"rgba(255, 122, 112, 0.08)", Commitment:"rgba(255, 179, 71, 0.08)", Intellectual:"rgba(76, 107, 155, 0.08)", Affable:"rgba(255, 182, 193, 0.08)", Recreational:"rgba(77, 210, 255, 0.08)", Partnership:"rgba(60, 179, 113, 0.08)", Stability:"rgba(255, 215, 0, 0.08)", Creative:"rgba(255, 102, 204, 0.08)", Conflict:"rgba(255, 165, 82, 0.08)", Physical:"rgba(255, 140, 105, 0.08)", Sexual:"rgba(230, 57, 70, 0.08)", ExtrovertedExpress:"rgba(255, 179, 71, 0.08)", ExtrovertedReceive:"rgba(255, 213, 128, 0.08)", ReflectiveExpress:"rgba(106, 76, 147, 0.08)", ReflectiveReceive:"rgba(166, 140, 194, 0.08)", SupportiveExpress:"rgba(136, 192, 208, 0.08)", SupportiveReceive:"rgba(178, 223, 219, 0.08)", AffableExpress:"rgba(76, 175, 80, 0.08)", AffableReceive:"rgba(163, 217, 119, 0.08)", StrongWilledExpress:"rgba(230, 57, 70, 0.08)", StrongWilledReceive:"rgba(255, 122, 112, 0.08)", SteadyConnector:"rgba(76, 175, 80, 0.08)", ReassuranceSeeker:"rgba(255, 173, 173, 0.08)", IndependentConnector:"rgba(136, 192, 208, 0.08)", GuardedConnector:"rgba(165, 165, 165, 0.08)" };

    const bondingInsights = {
      SteadyConnector:{desc:"You create a safe space for open communication.",challenges:"You may assume quick talks fix everything.",conflictStyle:"Seeks harmony; may avoid depth."},
      ReassuranceSeeker:{desc:"You thrive on frequent affirmations.",challenges:"Validation needs may overwhelm others.",conflictStyle:"May over-pursue reassurance."},
      IndependentConnector:{desc:"Calm, steady presence; values space.",challenges:"Space can feel like distance.",conflictStyle:"May withdraw or shut down."},
      GuardedConnector:{desc:"Builds trust gradually; dependable.",challenges:"Caution can slow openness.",conflictStyle:"May assume negative intent."}
    };

    const conflictStrategies = {
      SteadyConnector: {
        SteadyConnector: "Both value harmony; use weekly check‑ins to address issues early.",
        ReassuranceSeeker: "Offer explicit affirmations while keeping discussions grounded.",
        IndependentConnector: "Allow space first, then return to resolve with calm structure.",
        GuardedConnector: "Slow the pace; listen patiently and avoid pressuring."
      },
      ReassuranceSeeker: {
        SteadyConnector: "Ask for specific reassurance without over‑pursuing.",
        ReassuranceSeeker: "Schedule mutual affirmations; avoid spirals by timing out.",
        IndependentConnector: "Seek a brief reassurance, then honor space.",
        GuardedConnector: "Use gentle, concrete requests; avoid escalating tones."
      },
      IndependentConnector: {
        SteadyConnector: "Explain your need for reflection; set a return time.",
        ReassuranceSeeker: "Offer a quick assurance before stepping back.",
        IndependentConnector: "Agree on a clear pause‑and‑return window.",
        GuardedConnector: "Use structured check‑ins; keep tone steady."
      },
      GuardedConnector: {
        SteadyConnector: "Share gradually; acknowledge their harmony focus.",
        ReassuranceSeeker: "Offer small affirmations to reduce anxiety.",
        IndependentConnector: "Blend caution with steady pacing and check‑ins.",
        GuardedConnector: "Build trust with small daily gestures before hard topics."
      }
    };

    const scripture = {
      coreStrengths: "“Above all, love each other deeply, because love covers over a multitude of sins.” — 1 Peter 4:8",
      areasForGrowth: "“Let us consider how we may spur one another on toward love and good deeds.” — Hebrews 10:24",
      untappedOpps: "“See, I am doing a new thing! … Do you not perceive it?” — Isaiah 43:19",
      compassionCare: "“Be completely humble and gentle; be patient, bearing with one another in love.” — Ephesians 4:2",
      socialEngagement: "“Therefore encourage one another and build each other up.” — 1 Thessalonians 5:11",
      decisionLeadership: "“If any of you lacks wisdom, you should ask God … and it will be given to you.” — James 1:5",
      respectRecognition: "“Honor one another above yourselves.” — Romans 12:10",
      connectionPattern: "“Make every effort to keep the unity of the Spirit through the bond of peace.” — Ephesians 4:3",
      conflictStrategies: "“Everyone should be quick to listen, slow to speak and slow to become angry.” — James 1:19"
    };

    /* ================== Questions ================== */
    const questions = [
      { q: "When your spouse is stressed, what's your first instinct?", opts: [
          { text: "Lighten the mood with fun or a distraction.", t: "Extroverted", i: "Recreational" },
          { text: "Take charge and solve the problem.", t: "StrongWilled", i: "Conflict" },
          { text: "Offer advice or discuss the issue deeply.", t: "Reflective", i: "Intellectual" },
          { text: "Listen quietly and offer comfort.", t: "Affable", i: "Affable" },
          { text: "Help them quietly without being asked.", t: "Supportive", i: "Partnership" }
        ]
      },
      // ... add other questions following your original pattern ...
      { q: "Are you and your spouse aligned on values?", opts:[
          { text: "Strongly Agree", rr: 3 }, { text: "Agree", rr: 2 }, { text: "Somewhat Agree", rr: 1 },
          { text: "Disagree", rr:0 }, { text: "Strongly Disagree", rr:0 }
        ]
      }
    ];

    /* ================== State & Helpers ================== */
    let index = 0, tempScores = {}, wantedTempScores = {}, socialTempScores = {}, decisionTempScores = {},
        intimacyScores = {}, bondingScores = {}, respectRecognitionScore = 0, answers = [];
    const profiles = [];
    let mode = "solo", partnerIndex = 0, partnerAName = "", partnerBName = "";
    const TRAITS = ["Extroverted","StrongWilled","Reflective","Affable","Supportive"];

    function resetScores(){
      tempScores = {}; wantedTempScores = {}; socialTempScores = {}; decisionTempScores = {};
      TRAITS.forEach(t=>{ tempScores[t]=0; wantedTempScores[t]=0; socialTempScores[t]=0; decisionTempScores[t]=0; });
      intimacyScores = {}; Object.keys(intimacyDescriptions).forEach(k=>intimacyScores[k]=0);
      bondingScores = {}; respectRecognitionScore = 0; answers = [];
    }

    function normalizeIntimacyScores(){
      const counts = { Spiritual:0, Emotional:3, Commitment:2, Intellectual:3, Affable:4, Recreational:3, Partnership:4, Stability:2, Creative:2, Conflict:2, Physical:2, Sexual:0 };
      const out = {};
      Object.keys(intimacyDescriptions).forEach(k=>{
        out[k] = counts[k] ? (intimacyScores[k]/counts[k])*3 : 0;
      });
      return out;
    }

    function getAffectionPreferences(){
      const sortTop = obj => Object.entries(obj).sort((a,b)=>b[1]-a[1])[0]?.[0];
      const express = sortTop(tempScores), want = sortTop(wantedTempScores);
      const map = {
        Extroverted: { expressed:"You express love in a recreational style...", desired:"You feel loved through recreational moments." },
        StrongWilled: { expressed:"You express love by fixing problems or taking initiative.", desired:"You feel loved when effort is recognized." },
        Reflective: { expressed:"You express love through deep, supportive exchanges.", desired:"You feel loved through thoughtful connection." },
        Affable: { expressed:"You express love with warmth and reassurance.", desired:"You feel loved through calm presence." },
        Supportive: { expressed:"You express love through practical collaboration.", desired:"You feel loved through teamwork." }
      };
      return {
        expressed: map[express]?.expressed || "",
        expressedType: express + "Express",
        desired: map[want]?.desired || "",
        desiredType: want + "Receive"
      };
    }

    function getSocialPreferences(){
      const top = Object.entries(socialTempScores).sort((a,b)=>b[1]-a[1])[0]?.[0];
      const map = {
        Extroverted:"You bring energy and enthusiasm to social settings.",
        StrongWilled:"You lead and organize social interactions.",
        Reflective:"You prefer deep, thoughtful conversations.",
        Affable:"You enjoy calm, low‑key interactions.",
        Supportive:"You foster inclusion with quiet support."
      };
      return map[top] || "You adapt flexibly to social settings.";
    }

    function getDecisionLeadershipStyle(){
      const top = Object.entries(decisionTempScores).sort((a,b)=>b[1]-a[1])[0]?.[0];
      const map = {
        Extroverted:"You decide with enthusiasm and fun first.",
        StrongWilled:"You decide decisively and goal‑first.",
        Reflective:"You analyze carefully before deciding.",
        Affable:"You choose harmony and flow.",
        Supportive:"You support others thoughtfully."
      };
      return map[top] || "You balance leadership and collaboration.";
    }

    function getBondingStyle(){
      return Object.entries(bondingScores).sort((a,b)=>b[1]-a[1])[0]?.[0] || "SteadyConnector";
    }

    function rrLabel(score){
      if(score >= 5) return "Strong";
      if(score >= 3) return "Moderate";
      return "Needs Attention";
    }

    /* ================== UI Wiring ================== */
    document.addEventListener("DOMContentLoaded", ()=>{
      const coupleToggle = document.getElementById("coupleModeToggle");
      const partnerBInput = document.getElementById("partnerBName");

      function toggleCoupleMode(){
        partnerBInput.classList.toggle("hidden", !coupleToggle.checked);
        mode = coupleToggle.checked ? "couple" : "solo";
      }

      coupleToggle.addEventListener("change", toggleCoupleMode);
      toggleCoupleMode();
      document.getElementById("startQuizBtn").addEventListener("click", startQuiz);
    });

    function startQuiz(){
      mode = document.getElementById("coupleModeToggle").checked ? "couple" : "solo";
      partnerAName = document.getElementById("partnerAName").value.trim() || "Partner A";
      partnerBName = document.getElementById("partnerBName").value.trim() || "Partner B";
      resetScores(); index = 0; partnerIndex = 0; profiles.length = 0;
      document.getElementById("introPage").classList.add("hidden");
      document.getElementById("quizPage").classList.remove("hidden");
      document.getElementById("quizTitle").textContent = mode==="couple" ? `Intimacy Profile Assessment — ${partnerAName}` : "Intimacy Profile Assessment";
      showQuestion();
    }

    function showQuestion(){
      const q = questions[index];
      document.getElementById("progress").textContent = `Question ${index+1} of ${questions.length}`;
      document.getElementById("progressBar").style.width = `${((index+1)/questions.length)*100}%`;
      let html = `<h3 id="questionLabel">${q.q}</h3>`;
      q.opts.forEach((o,i)=> html += `<button class="answer-btn" onclick="answer(${i})">${o.text}</button>`);
      document.getElementById("questionContainer").innerHTML = html;
      document.getElementById("backBtn").style.display = index>0 ? "block" : "none";
    }

    function answer(i){
      const o = questions[index].opts[i];
      if(!o) return;
      answers[index] = i;
      if(o.t){
        if(o.rr!==undefined){
          respectRecognitionScore += o.rr;
        } else if(o.domain==="Affection" && o.wanted){
          wantedTempScores[o.t]++;
        } else if(o.domain==="Social"){
          socialTempScores[o.t]++;
        } else if(o.domain==="Decision"){
          decisionTempScores[o.t]++;
        } else {
          tempScores[o.t]++;
        }
      }
      if(o.i) intimacyScores[o.i] = (intimacyScores[o.i]||0) + 1;
      if(o.b) bondingScores[o.b] = (bondingScores[o.b]||0) + 1;
      index++;
      index < questions.length ? showQuestion() : showResults();
    }

    function goBack(){
      if(index === 0) return;
      index--;
      const prev = questions[index].opts[answers[index]];
      if(prev?.t){
        if(prev.rr!==undefined){
          respectRecognitionScore -= prev.rr;
        } else if(prev.domain==="Affection" && prev.wanted){
          wantedTempScores[prev.t]--;
        } else if(prev.domain==="Social"){
          socialTempScores[prev.t]--;
        } else if(prev.domain==="Decision"){
          decisionTempScores[prev.t]--;
        } else {
          tempScores[prev.t]--;
        }
      }
      if(prev?.i) intimacyScores[prev.i]--;
      if(prev?.b) bondingScores[prev.b]--;
      showQuestion();
    }

    /* ================== Helpers for blocks ================== */
    function itemsBlocks(items){
      return items.map(([type]) => `
        <div class="result-block" style="border-left:8px solid ${typeColors[type]}; background:${typeColorsWithOpacity[type]};">
          <strong>${type}</strong> – ${intimacyDescriptions[type].desc}
        </div>`).join("");
    }

    function section1CIFM(){
      return `
        <div class="section-divider"></div>
        <h3 class="section-title">Section 1: Exploring the Covenant Intimacy Fulfillment Model™ (CIFM)</h3>
        <p class="intro-text">The CIFM organizes intimacy into 12 types across four categories balancing “being together” and “doing together.” Use this shared language to explore your connection.</p>
        <ul class="results-list">
          <li><strong>Core:</strong> Spiritual, Emotional, Commitment</li>
          <li><strong>Relational:</strong> Intellectual, Affable, Recreational</li>
          <li><strong>Partnership:</strong> Partnership, Stability, Creative, Conflict</li>
          <li><strong>Physical:</strong> Physical, Sexual</li>
        </ul>`;
    }

    function summarizeForProfile(){
      const normalized = normalizeIntimacyScores();
      const sorted = Object.entries(normalized).sort((a,b)=>b[1]-a[1]);
      const priority = sorted.slice(0,4), progress = sorted.slice(4,8), presence = sorted.slice(8,12);
      const affectionPrefs = getAffectionPreferences();
      const socialPreferences = getSocialPreferences();
      const decisionLeadershipStyle = getDecisionLeadershipStyle();
      const bondingKey = getBondingStyle();
      const bondingLabel = bondingKey.replace(/([a-z])([A-Z])/g,'$1 $2');
      const rrScore = respectRecognitionScore;
      const rrLabelTxt = rrLabel(rrScore);
      return { priority, progress, presence, affectionPrefs, socialPreferences, decisionLeadershipStyle, bondingKey, bondingLabel, respectRecognitionScore: rrScore, respectRecognitionLabel: rrLabelTxt };
    }

    function renderSoloAsStacked(name, profile){
      function stackCategorySection({title, verse, intro, promptsHtml}, items){
        return `
          <div class="subsection-divider"></div>
          <h4 class="subsection-title">${title}</h4>
          <div class="verse">${verse}</div>
          <p class="intro-text">${intro}</p>
          <div class="couple-grid solo-item">
            <div class="partner-card">
              <div class="partner-inner">
                <div class="partner-header">${name}</div>
                ${itemsBlocks(items)}
              </div>
            </div>
          </div>
          <div class="discussion-prompts">
            <strong>Discussion Prompts:</strong>
            ${promptsHtml}
          </div>`;
      }

      const section1 = section1CIFM();

      const section2Texts = {
        core: {
          title: "Core Connection Strengths",
          verse: scripture.coreStrengths,
          intro: "Your top four intimacy types are your most natural on‑ramps to closeness—nurture these intentionally.",
          promptsHtml: `
            <ul class="results-list">
              <li><em>Explore:</em> Why do these strengths matter to you?</li>
              <li><em>Be Creative:</em> Practice one strength this week.</li>
              <li><em>Share:</em> What did you learn about yourself?</li>
            </ul>`
        },
        growth: {
          title: "Areas for Growth",
          verse: scripture.areasForGrowth,
          intro: "Familiar but less dominant—intentionally exploring these can deepen your connection.",
          promptsHtml: `
            <ul class="results-list">
              <li><em>Perspective:</em> Which growth area intrigues you?</li>
              <li><em>Your Move:</em> What small step feels fun to try?</li>
              <li><em>Just for Fun:</em> Design a mini “growth date” activity.</li>
            </ul>`
        },
        untapped: {
          title: "Untapped Opportunities",
          verse: scripture.untappedOpps,
          intro: "Rarely used pathways—trying one could unlock a fresh connection dynamic.",
          promptsHtml: `
            <ul class="results-list">
              <li><em>Pioneer:</em> Which low‑scored type stands out?</li>
              <li><em>First Step:</em> Choose one small way to explore it.</li>
              <li><em>Share:</em> What could growing here mean?</li>
            </ul>`
        }
      };

      const section2core = stackCategorySection(section2Texts.core, profile.priority);
      const section2growth = stackCategorySection(section2Texts.growth, profile.progress);
      const section2untapped = stackCategorySection(section2Texts.untapped, profile.presence);

      const section3 = `
        <div class="section-divider"></div>
        <h3 class="section-title">Section 3: Relational Dynamics</h3>
        <div class="verse">${scripture.compassionCare}</div>
        <p class="intro-text">Discover how you express love, your social energy, leadership style, and need for recognition.</p>
        <div class="couple-grid solo-item">
          <div class="partner-card">
            <div class="partner-inner"><div class="partner-header">${name}</div>
              <div class="result-block" style="border-left:8px solid ${typeColors[profile.affectionPrefs.expressedType]}; background:${typeColorsWithOpacity[profile.affectionPrefs.expressedType]};"><strong>How You Express Love:</strong> ${profile.affectionPrefs.expressed}</div>
              <div class="result-block" style="border-left:8px solid ${typeColors[profile.affectionPrefs.desiredType]}; background:${typeColorsWithOpacity[profile.affectionPrefs.desiredType]};"><strong>How You Feel Most Loved:</strong> ${profile.affectionPrefs.desired}</div>
              <div class="result-block" style="border-left:8px solid #FFB347; background:rgba(255,179,71,0.08);"><strong>Your Social Energy:</strong> ${profile.socialPreferences}</div>
              <div class="result-block" style="border-left:8px solid #4D9DE0; background:rgba(77,157,224,0.08);"><strong>Your Leadership Style:</strong> ${profile.decisionLeadershipStyle}</div>
              <div class="result-block" style="border-left:8px solid #6A4C93; background:rgba(106,76,147,0.08);"><strong>Your Respect &amp; Recognition:</strong> ${profile.respectRecognitionLabel} (${profile.respectRecognitionScore}/6)</div>
            </div>
          </div>
        </div>
        <div class="discussion-prompts">
          <strong>Discussion Prompts: Reflect & Grow</strong>
          <ul class="results-list">
            <li>Choose one Core strength to practice intentionally.</li>
            <li>Try a small step in an Area for Growth and reflect on the experience.</li>
          </ul>
        </div>`;

      const section4 = `
        <div class="section-divider"></div>
        <h3 class="section-title">Section 4: Connection Patterns</h3>
        <div class="verse">${scripture.connectionPattern}</div>
        <p class="intro-text">This insight reveals your natural pattern for connection and conflict—how you repair and relate under strain.</p>
        <div class="couple-grid solo-item">
          <div class="partner-card">
            <div class="partner-inner"><div class="partner-header">${name}</div>
              <div class="result-block" style="border-left:8px solid ${typeColors[profile.bondingKey]}; background:${typeColorsWithOpacity[profile.bondingKey]};">
                <strong>${profile.bondingLabel}</strong>
                <p><strong>Strengths:</strong> ${bondingInsights[profile.bondingKey].desc}</p>
                <p><strong>Challenges:</strong> ${bondingInsights[profile.bondingKey].challenges}</p>
                <p><strong>Conflict Style:</strong> ${bondingInsights[profile.bondingKey].conflictStyle}</p>
              </div>
            </div>
          </div>
        </div>`;

      const thankYouSection = `
        <div class="section-divider"></div>
        <h3 class="section-title">thank you</h3>
        <p class="intro-text">We hope you had fun exploring your connection strengths! This assessment is meant to inspire curiosity, not labels. Let it spark meaningful conversation and growth.</p>`;

      const challengeSection = `
        <div class="section-divider"></div>
        <h3 class="section-title">Your Continuing Connection Challenge</h3>
        <div class="verse">“May the Lord make your love increase and overflow….” — 1 Thessalonians 3:12</div>
        <p class="intro-text">This assessment is just the beginning! Choose one insight or practice to experiment with each week—may your love continue to overflow.</p>
        <div class="section-divider"></div>
        <button id="downloadPdfBtn" class="btn" style="max-width:260px;">Download Individual PDF</button>`;

      return `
        <div id="stackedSoloReport" class="solo-layout">
          ${section1}
          ${section2core}${section2growth}${section2untapped}
          ${section3}
          ${section4}
          ${thankYouSection}
          ${challengeSection}
        </div>`;
    }

    function renderCoupleComparison(){
      const A = profiles[0], B = profiles[1];

      document.getElementById('resultsIntro').classList.remove('hidden');

      const topA = A.priority.map(([t]) => t);
      const topB = B.priority.map(([t]) => t);
      const overlap = topA.filter(t => topB.includes(t));
      const onlyA = topA.filter(t => !topB.includes(t));
      const onlyB = topB.filter(t => !topA.includes(t));
      const bubble = t => `<span class="pill" style="border-left:6px solid ${typeColors[t]}; background:${typeColorsWithOpacity[t]};">${t}</span>`;

      const section2Texts = {
        core: {
          title: "Core Connection Strengths",
          verse: scripture.coreStrengths,
          intro: "These are natural ways you connect deeply—celebrate them.",
          promptsHtml: `
            <ul class="results-list">
              <li><em>Explore:</em> Why do these matter?</li>
              <li><em>Be Creative:</em> Try one activity using your partner’s strength.</li>
              <li><em>Share:</em> What did you learn about how they connect?</li>
            </ul>`
        },
        growth: {
          title: "Areas for Growth",
          verse: scripture.areasForGrowth,
          intro: "Familiar but less dominant—tiny efforts here can accelerate connection.",
          promptsHtml: `
            <ul class="results-list">
              <li><em>My Perspective:</em> Which growth area excites you?</li>
              <li><em>Your Perspective:</em> What could I do to encourage you here?</li>
              <li><em>Just for Fun:</em> Plan a “growth date” combining both areas.</li>
            </ul>`
        },
        untapped: {
          title: "Untapped Opportunities",
          verse: scripture.untappedOpps,
          intro: "Little-known pathways—small steps can lead to big discoveries together.",
          promptsHtml: `
            <ul class="results-list">
              <li><em>Pioneer:</em> Which hidden type intrigues you?</li>
              <li><em>First Step:</em> Try it with no pressure.</li>
              <li><em>Share Your Heart:</em> What could growth here feel like?</li>
            </ul>`
        }
      };

      const container = document.createElement("div");
      container.id = "couplesReport";
      container.innerHTML = section1CIFM();

      container.innerHTML += `
        <div class="section-divider"></div>
        <h3 class="section-title">Intimacy Type Strengths</h3>
        <div class="subsection-divider"></div>
        <h4 class="subsection-title">Shared Strengths</h4>
        <p class="intro-text">Your overlapping strengths—lean into these as your foundation.</p>
        <div class="overlap-box" style="margin-top:10px;">
          ${ overlap.length ? overlap.map(bubble).join(" ") : "<em>No overlapping strengths—great chance to learn each other’s favorites.</em>" }
        </div>
        <div class="subsection-divider"></div>
        <h4 class="subsection-title">Individual Strengths</h4>
        <p class="intro-text">Unique strengths each of you bring—celebrate and explore together.</p>
        <div class="overlap-box" style="margin-top:10px;">
          <div style="margin-top:6px;"><strong>${A.name}:</strong> ${onlyA.length ? onlyA.map(bubble).join(" ") : "<em>—</em>"}</div>
          <div style="margin-top:6px;"><strong>${B.name}:</strong> ${onlyB.length ? onlyB.map(bubble).join(" ") : "<em>—</em>"}</div>
        </div>`;

      container.innerHTML += `
        <div class="section-divider"></div>
        <h3 class="section-title">Section 2: Your Intimacy Preferences</h3>
        <p class="intro-text">See how you uniquely connect—side-by-side for mutual discovery.</p>`;

      container.innerHTML += coupleCategorySection(section2Texts.core, A.priority, B.priority, A.name, B.name);
      container.innerHTML += coupleCategorySection(section2Texts.growth, A.progress, B.progress, A.name, B.name);
      container.innerHTML += coupleCategorySection(section2Texts.untapped, A.presence, B.presence, A.name, B.name);
      container.innerHTML += buildSection3RelationalDynamics(A,B);
      container.innerHTML += buildConnectionPatternsSection(A,B);
      container.innerHTML += couplesConflictSection(A,B);

      container.innerHTML += `
        <div class="section-divider"></div>
        <h3 class="section-title">thank you</h3>
        <p class="intro-text">Thanks for exploring—may this be a stepping stone to deeper connection and joy in your marriage.</p>
        <div class="section-divider"></div>
        <h3 class="section-title">Your Continuing Connection Challenge</h3>
        <div class="verse">“May the Lord make your love increase and overflow….” — 1 Thessalonians 3:12</div>
        <p class="intro-text">Keep choosing curiosity and connection—practice one insight each week.</p>
        <div class="section-divider"></div>
        <button id="downloadPdfBtn" class="btn" style="max-width:260px;">Download Couples PDF</button>`;

      document.getElementById('resultsHeader').textContent = "Couples Comparison Profiles";
      const resultsEl = document.getElementById('results');
      resultsEl.innerHTML = "";
      resultsEl.appendChild(container);

      document.getElementById("downloadPdfBtn").onclick = () => {
        document.body.classList.add('no-anim');
        const target = document.getElementById('couplesReport');
        const filename = `${A.name}-${B.name}-Marriage-Connection-Report.pdf`.replace(/\s+/g,'_');
        requestAnimationFrame(() => {
          html2pdf().set({
            margin:[0.5,0.5,0.5,0.5],
            filename,
            image:{ type:'jpeg', quality:0.98 },
            html2canvas:{ scale:2, useCORS:true, logging:false, windowWidth: document.documentElement.scrollWidth, windowHeight: document.documentElement.scrollHeight },
            jsPDF:{ unit:'in', format:'letter', orientation:'portrait' },
            pagebreak:{ mode:['css','legacy'] }
          }).from(target).save().then(()=>{
            document.body.classList.remove('no-anim');
          }).catch(()=>{
            document.body.classList.remove('no-anim');
          });
        });
      };

      document.getElementById('quizPage').classList.add('hidden');
      document.getElementById('resultPage').classList.remove('hidden');
      document.getElementById('coupleFlowBtns').classList.add('hidden');
    }

    /* Couple section function references: reuse as-is from original code */
    function coupleCategorySection({title, verse, intro, promptsHtml}, Aitems, Bitems, Aname, Bname){
      return `
        <div class="subsection-divider"></div>
        <h4 class="subsection-title">${title}</h4>
        <div class="verse">${verse}</div>
        <p class="intro-text">${intro}</p>

        <div class="couple-grid">
          <div class="partner-card"><div class="partner-inner">
            <div class="partner-header">${Aname}</div>
            ${itemsBlocks(Aitems)}
          </div></div>
          <div class="partner-card"><div class="partner-inner">
            <div class="partner-header">${Bname}</div>
            ${itemsBlocks(Bitems)}
          </div></div>
        </div>

        <div class="discussion-prompts">
          <strong>Discussion Prompts:</strong>
          ${promptsHtml}
        </div>`;
    }

    function buildSection3RelationalDynamics(A,B){
      const expressBlock = p => `
        <div class="result-block" style="border-left:8px solid ${typeColors[p.affectionPrefs.expressedType]}; background:${typeColorsWithOpacity[p.affectionPrefs.expressedType]};">
          <strong>How You Express Love:</strong> ${p.affectionPrefs.expressed}
        </div>
        <div class="result-block" style="border-left:8px solid ${typeColors[p.affectionPrefs.desiredType]}; background:${typeColorsWithOpacity[p.affectionPrefs.desiredType]};">
          <strong>How You Feel Most Loved:</strong> ${p.affectionPrefs.desired}
        </div>`;
      const socialBlock = p => `
        <div class="result-block" style="border-left:8px solid #FFB347; background:rgba(255,179,71,0.08);">
          <strong>Your Social Energy:</strong> ${p.socialPreferences}
        </div>`;
      const powerBlock = p => `
        <div class="result-block" style="border-left:8px solid #4D9DE0; background:rgba(77,157,224,0.08);">
          <strong>Your Leadership Style:</strong> ${p.decisionLeadershipStyle}
        </div>`;
      const rrBlock = p => `
        <div class="result-block" style="border-left:8px solid #6A4C93; background:rgba(106,76,147,0.08);">
          <strong>Your Respect &amp; Recognition:</strong> ${p.respectRecognitionLabel} (${p.respectRecognitionScore}/6)
        </div>`;

      return `
        <div class="section-divider"></div>
        <h3 class="section-title">Section 3: Relational Dynamics</h3>
        <div class="verse">${scripture.compassionCare}</div>
        <p class="intro-text">Your relational dynamics are the everyday rhythms of your connection...</p>

        <div class="subsection-divider"></div>
        <h4 class="subsection-title">Compassion and Care</h4>
        <p class="intro-text">This dynamic represents your capacity to show empathy and how you desire care.</p>
        <div class="couple-grid">
          <div class="partner-card"><div class="partner-inner"><div class="partner-header">${A.name}</div>${expressBlock(A)}</div></div>
          <div class="partner-card"><div class="partner-inner"><div class="partner-header">${B.name}</div>${expressBlock(B)}</div></div>
        </div>
        <div class="discussion-prompts">
          <strong>Discussion Prompts: Let's Show Up for Each Other</strong>
          <ul class="results-list">
            <li><em>A "Love Note" to Each Other:</em> Based on your spouse's "How You Feel Most Loved" result, write them a short note of appreciation.</li>
            <li><em>A Curious Question:</em> Ask, "What's a small thing I could do to make you feel especially loved today?"</li>
          </ul>
        </div>

        <div class="subsection-divider"></div>
        <h4 class="subsection-title">Social Preferences</h4>
        <p class="intro-text">This dynamic explores how you prefer to engage socially.</p>
        <div class="couple-grid">
          <div class="partner-card"><div class="partner-inner"><div class="partner-header">${A.name}</div>${socialBlock(A)}</div></div>
          <div class="partner-card"><div class="partner-inner"><div class="partner-header">${B.name}</div>${socialBlock(B)}</div></div>
        </div>
        <div class="discussion-prompts">
          <strong>Discussion Prompts: Let's Find Our Rhythm</strong>
          <ul class="results-list">
            <li><em>The Best of Both Worlds:</em> Share one energized and one quiet moment that recharged you.</li>
            <li><em>A "We" and "Me" Plan:</em> Choose one couple activity and one solo recharge time this week.</li>
          </ul>
        </div>

        <div class="subsection-divider"></div>
        <h4 class="subsection-title">Power and Control</h4>
        <p class="intro-text">This dynamic uncovers your preferred role in decision-making and leadership.</p>
        <div class="couple-grid">
          <div class="partner-card"><div class="partner-inner"><div class="partner-header">${A.name}</div>${powerBlock(A)}</div></div>
          <div class="partner-card"><div class="partner-inner"><div class="partner-header">${B.name}</div>${powerBlock(B)}</div></div>
        </div>
        <div class="discussion-prompts">
          <strong>Discussion Prompts: A Power &amp; Trust Talk</strong>
          <ul class="results-list">
            <li><em>A Shared Goal:</em> Talk about a decision this week and how to use your strengths to decide together.</li>
            <li><em>A Trust Check-in:</em> Ask, "When do you feel most respected and trusted in decisions?"</li>
          </ul>
        </div>

        <div class="subsection-divider"></div>
        <h4 class="subsection-title">Respect and Recognition</h4>
        <p class="intro-text">This dynamic highlights your need for affirmation and how you value recognition.</p>
        <div class="couple-grid">
          <div class="partner-card"><div class="partner-inner"><div class="partner-header">${A.name}</div>${rrBlock(A)}</div></div>
          <div class="partner-card"><div class="partner-inner"><div class="partner-header">${B.name}</div>${rrBlock(B)}</div></div>
        </div>
        <div class="discussion-prompts">
          <strong>Discussion Prompts: Let's Celebrate Each Other!</strong>
          <ul class="results-list">
            <li><em>A "High Five" Moment:</em> Share a moment you felt genuinely appreciated this week.</li>
            <li><em>The "One Thing" Challenge:</em> Each share one new way you’ll show appreciation this week.</li>
          </ul>
        </div>`;
    }

    function buildConnectionPatternsSection(A,B){
      return `
        <div class="section-divider"></div>
        <h3 class="section-title">Section 4: Connection Patterns</h3>
        <div class="verse">${scripture.connectionPattern}</div>
        <p class="intro-text">See how you each approach tension and repair connection in conflict.</p>
        <div class="couple-grid">
          <div class="partner-card"><div class="partner-inner">
            <div class="partner-header">${A.name}</div>
            <div class="result-block" style="border-left:8px solid ${typeColors[A.bondingKey]}; background:${typeColorsWithOpacity[A.bondingKey]};">
              <strong>${A.bondingLabel}</strong>
              <p><strong>Strengths:</strong> ${bondingInsights[A.bondingKey].desc}</p>
              <p><strong>Challenges:</strong> ${bondingInsights[A.bondingKey].challenges}</p>
              <p><strong>Conflict Style:</strong> ${bondingInsights[A.bondingKey].conflictStyle}</p>
            </div>
          </div></div>
          <div class="partner-card"><div class="partner-inner">
            <div class="partner-header">${B.name}</div>
            <div class="result-block" style="border-left:8px solid ${typeColors[B.bondingKey]}; background:${typeColorsWithOpacity[B.bondingKey]};">
              <strong>${B.bondingLabel}</strong>
              <p><strong>Strengths:</strong> ${bondingInsights[B.bondingKey].desc}</p>
              <p><strong>Challenges:</strong> ${bondingInsights[B.bondingKey].challenges}</p>
              <p><strong>Conflict Style:</strong> ${bondingInsights[B.bondingKey].conflictStyle}</p>
            </div>
          </div></div>
        </div>`;
    }

    function couplesConflictSection(A,B){
      const aToB = conflictStrategies[A.bondingKey][B.bondingKey];
      const bToA = conflictStrategies[B.bondingKey][A.bondingKey];
      const shared = `Understanding your individual patterns is powerful—but the real magic happens when you build a bridge between them, fostering safety even in tension.`;

      return `
        <div class="section-divider"></div>
        <h3 class="section-title">Personalized Conflict Resolution Strategies</h3>
        <div class="verse">${scripture.conflictStrategies}</div>
        <p class="intro-text">Learn how to navigate tension in ways that honor both of your needs.</p>
        <table>
          <tr><th>Partner</th><th>Style</th><th>Strategy</th></tr>
          <tr><td>${A.name}</td><td>${A.bondingLabel}</td><td>${aToB}</td></tr>
          <tr><td>${B.name}</td><td>${B.bondingLabel}</td><td>${bToA}</td></tr>
        </table>
        <div class="result-block" style="border-left:8px solid #4D9DE0; background:rgba(77,157,224,0.08);">
          <strong>Shared Strategy: Bridging Our Needs</strong>
          <p>${shared}</p>
        </div>`;
    }

    /* ================== Results Flow ================== */
    function showResults(){
      document.getElementById("quizPage").classList.add("hidden");
      document.getElementById("resultPage").classList.remove("hidden");

      if(mode === "solo") {
        const name = partnerAName || "You";
        const profile = summarizeForProfile();
        profile.name = name;

        document.getElementById("resultsHeader").textContent = "Your Personalized Connection Profile";
        document.getElementById("resultsIntro").classList.remove("hidden");
        document.getElementById("results").innerHTML = renderSoloAsStacked(name, profile);
        document.getElementById("coupleFlowBtns").classList.add("hidden");

        document.getElementById("downloadPdfBtn").onclick = () => {
          document.body.classList.add("no-anim");
          const target = document.getElementById("stackedSoloReport");
          const filename = `${name}-Marriage-Connection-Report.pdf`.replace(/\s+/g,'_');
          requestAnimationFrame(() => {
            html2pdf().set({
              margin:[0.5,0.5,0.5,0.5],
              filename,
              image:{ type:'jpeg', quality:0.98 },
              html2canvas:{ scale:2, useCORS:true, logging:false, windowWidth: document.documentElement.scrollWidth, windowHeight: document.documentElement.scrollHeight },
              jsPDF:{ unit:'in', format:'letter', orientation:'portrait' },
              pagebreak:{ mode:['css','legacy'] }
            }).from(target).save().then(()=>{
              document.body.classList.remove('no-anim');
            }).catch(()=>{
              document.body.classList.remove('no-anim');
            });
          });
        };

      } else {
        if(partnerIndex === 0) {
          const name = partnerAName || "Partner A";
          const built = summarizeForProfile();
          profiles[0] = { ...built, name };

          document.getElementById("resultsHeader").textContent = "Partner Handoff";
          document.getElementById("resultsIntro").classList.add("hidden");
          document.getElementById("results").innerHTML = `
            <div class="handoff">
              <h3 class="section-title" style="margin-top:0;">Thank you, ${name}!</h3>
              <p class="intro-text">We'll reveal the combined results once both partners finish.</p>
              <p class="intro-text"><strong>Please pass the device to ${partnerBName || "Partner B"}</strong>.</p>
            </div>`;
          document.getElementById("coupleFlowBtns").classList.remove("hidden");
          document.getElementById("startPartnerBBtn").onclick = ()=>{
            partnerIndex = 1;
            resetScores(); index = 0;
            document.getElementById("resultPage").classList.add("hidden");
            document.getElementById("quizPage").classList.remove("hidden");
            document.getElementById("quizTitle").textContent = `Intimacy Profile Assessment — ${partnerBName || "Partner B"}`;
            showQuestion();
          };
        } else {
          const name = partnerBName || "Partner B";
          const built = summarizeForProfile();
          profiles[1] = { ...built, name };
          renderCoupleComparison();
        }
      }
    }
  </script>
</body>
</html>
